name: Check C++ Formatting

on:
  push:
    branches:
      - main
      - '*_with_ci'
  pull_request:
    branches: main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check C++ formatting
        uses: RafikFarhad/clang-format-github-action@v3
        with:
          sources: "src/**/*.cpp,src/**/*.h,src/**/*.cc,src/**/*.cxx,src/**/*.hpp,src/**/*.cu,src/**/*.cuh"
          excludes: "include/**/*,src/gui/wxformbuilder/**/*,src/gui/*ProjectX_gui*"
          style: file

  # Build workflows - prioritized execution: 2 jobs at a time
  # Tier 1: Most important builds (GPU debug + GPU release)
  build-gpu-debug:
    needs: check-format
    uses: ./.github/workflows/debug_build.yml

  build-gpu-release:
    needs: check-format
    uses: ./.github/workflows/release_build.yml

  # Tier 2: Secondary builds (requires Tier 1 to complete)
  build-gpu-release-gnu-mkl:
    needs: [build-gpu-debug, build-gpu-release]
    uses: ./.github/workflows/release_build_GNU_mkl.yml

  build-gpu-release-no-fastfft:
    needs: [build-gpu-debug, build-gpu-release]
    uses: ./.github/workflows/release_build_clang_noFastFFT.yml

  # Tier 3: CPU-only builds (requires Tier 2 to complete)
  build-cpu-debug:
    needs: [build-gpu-release-gnu-mkl, build-gpu-release-no-fastfft]
    uses: ./.github/workflows/debug_build_cpu_only.yml

  build-cpu-release:
    needs: [build-gpu-release-gnu-mkl, build-gpu-release-no-fastfft]
    uses: ./.github/workflows/release_build_cpu_only.yml

  # GPU tests - uncomment once gpu_runner is configured
  # Also requires:
  #   1. Uncommenting artifact upload in run_builds.yml
  #   2. Renaming gpu_tests.yml to run_gpu_tests.yml
  #   3. Deleting the build job from that workflow
  # gpu-tests:
  #   needs: build-gpu-debug
  #   uses: ./.github/workflows/run_gpu_tests.yml
  #   with:
  #     build_type: GPU_debug
