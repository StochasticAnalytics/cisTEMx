name: GPU Tests

# TODO: When integrating into CI pipeline:
# 1. Rename this file to run_gpu_tests.yml
# 2. Delete the 'build' job below (lines marked with DELETE comments)
# 3. Uncomment artifact upload in run_builds.yml
# 4. Update test job to accept build_type as workflow input
# 5. Uncomment gpu-tests section in check_formatting.yml

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (GPU_debug or GPU_release)'
        required: false
        type: choice
        options:
          - GPU_debug
          - GPU_release
        default: GPU_debug

# DELETE THIS ENTIRE JOB when using in CI pipeline (reuses build from debug_build.yml)
jobs:
  build:
    runs-on: ubuntu-latest
    container:
      # NOTE: Container version must match .vscode/CONTAINER_VERSION_TOP
      image: ghcr.io/stochasticanalytics/cistem_build_env:v3.0.1
      options: --user root --rm
    outputs:
      version: ${{ steps.configure.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git safe directory
        run: git config --global --add safe.directory /__w/cisTEMx/cisTEMx

      - name: Regenerate project
        run: ./regenerate_project.sh

      - name: Configure
        id: configure
        env:
          CC: clang
          CXX: clang++
        run: |
          export PATH=/usr/bin:$PATH
          mkdir -p build/${{ inputs.build_type }}
          cd build/${{ inputs.build_type }}
          echo $CC
          echo $CXX
          if [ "${{ inputs.build_type }}" = "GPU_debug" ]; then
            CONFIGURE_OPTS="--enable-gpu-debug --enable-debugmode"
          else
            CONFIGURE_OPTS="--enable-gpu"
          fi

          ../../configure $CONFIGURE_OPTS --with-cuda=/usr/local/cuda --with-wx-config=/opt/WX/wx305-clang-static-gtk2/bin/wx-config --enable-staticmode --enable-experimental --disable-build-all --enable-openmp --enable-fp16-particlestacks --disable-multiple-global-refinements --enable-profiling

          VERSION=$(cat config.log | grep CISTEM_VERSION_TEXT | cut -d' ' -f3 | tr -d '"')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Built version: $VERSION"
      - uses: ammaraskar/gcc-problem-matcher@master
      - name: make
        run: |
          export PATH=/usr/bin:$PATH
          workdir=$(pwd)
          cd build/${{ inputs.build_type }} && make -j4
          cd $workdir
          cp scripts/testing/test_and_benchmark.sh build/${{ inputs.build_type }}/src/
      - name: Prepare artifact
        run: |
          cd build/${{ inputs.build_type }}/src
          chmod +x *
          mkdir artifacts
          mv unit_test_runner samples_functional_testing console_test artifacts/

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: cistem_binaries_${{ inputs.build_type }}
          path: build/${{ inputs.build_type }}/src/artifacts
          retention-days: 1
# END DELETE - Keep everything below this line

  test:
    needs: build  # TODO: Remove this line when integrating with CI (no build dependency)
    runs-on: gpu_runner

    steps:
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          # NOTE: This artifact name must match the upload in run_builds.yml (cistem_binaries_GPU_debug)
          name: cistem_binaries_${{ inputs.build_type }}
          path: ./binaries

      - name: Setup environment
        run: |
          chmod +x binaries/*
          cd binaries
          ls -lh

      - name: Console test
        run: |
          cd binaries
          export PATH=/usr/bin:$PATH
          ./console_test

      - name: Samples functional testing
        run: |
          cd binaries
          export PATH=/usr/bin:$PATH
          ./samples_functional_testing

      - name: Unit tests
        run: |
          cd binaries
          export PATH=/usr/bin:$PATH
          ./unit_test_runner

      - name: Test summary
        if: always()
        run: |
          echo "### GPU Tests Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build type:** ${{ inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
