name: Push Container to GHCR

# This workflow helps push locally built containers to GitHub Container Registry
# It can also be used to mirror existing DockerHub containers to GHCR

on:
  workflow_dispatch:
    inputs:
      source_image:
        description: 'Source image (e.g., cistemdashorg/cistem_build_env:v3.0.0)'
        required: true
        type: string
        default: 'cistemdashorg/cistem_build_env:v3.0.0'
      target_tag:
        description: 'Target tag for GHCR (e.g., v3.0.0)'
        required: true
        type: string
        default: 'v3.0.0'

jobs:
  push-to-ghcr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to DockerHub (for pulling source image)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: Pull source image
        run: |
          docker pull ${{ inputs.source_image }}

      - name: Tag for GHCR
        run: |
          docker tag ${{ inputs.source_image }} ghcr.io/cistem-org/cistem_build_env:${{ inputs.target_tag }}

      - name: Push to GHCR
        run: |
          docker push ghcr.io/cistem-org/cistem_build_env:${{ inputs.target_tag }}

      - name: Summary
        run: |
          echo "### Container pushed successfully! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** \`${{ inputs.source_image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** \`ghcr.io/cistem-org/cistem_build_env:${{ inputs.target_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Make the package public at: https://github.com/orgs/cistem-org/packages" >> $GITHUB_STEP_SUMMARY
          echo "2. Update CI workflows to use the new GHCR image" >> $GITHUB_STEP_SUMMARY
