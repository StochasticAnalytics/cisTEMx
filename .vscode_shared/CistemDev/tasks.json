{
    // See https://go.microsoft.com/fwlink/?LinkId=733558
    // for the documentation about the tasks.json format
    "version": "2.0.0",
    "options": {
        "env": {
            "cuda_dir": "/usr/local/cuda",
            "build_dir": "${workspaceFolder}/build",
            // -diag-file-append makes Intel compiler show absolute paths in error messages for easier IDE navigation
            "common_flags": "--enable-experimental --enable-openmp --disable-build-all --enable-profiling",
            "experimental_algo_flags": "--enable-fp16-particlestacks  --disable-multiple-global-refinements",
            "common_optional_programs": "--enable-build-scale-with-mask --enable-build-create-mask --enable-build-resample --enable-build-resize"
            // "common_optional_programs": "--enable-build-sharpen-map --enable-build-convert-binary-to-star --enable-build-convert-eer-to-mrc --enable-build-resize --enable-build-resample --enable-build-sum_all_mrc_files --enable-build-sum_all_tif_files --enable-build-convert_par_to_star --enable-build-quick_test"
        }
    },
    "tasks": [
        {
            "label": "Configure cisTEM build",
            "type": "shell",
            "command": "mkdir -p ${build_dir}/intel-gpu-static && cd ${build_dir}/intel-gpu-static && CC=icc CXX=icpc ../../configure ${input:additional_compiler_flags} --with-wx-config=/opt/WX/icc-static/bin/wx-config --enable-staticmode --with-cuda=${cuda_dir} ${experimental_algo_flags} ${common_optional_programs}  ${common_flags} "
        },
        {
            "label": "BUILD cisTEM",
            "type": "shell",
            "command": "cd ${build_dir}/intel-gpu-static && make -j${input:compile_cores} 2>&1 | sed -u 's|../../../src/|${workspaceFolder}/src/|g'",
            "problemMatcher": {
                "owner": "icpc",
                "fileLocation": "absolute",
                "pattern": {
                    "regexp": "^(.*)\\((\\d+)\\):\\s+(warning|error|remark)\\s+#?(\\d+)?:\\s+(.*)$",
                    "file": 1,
                    "line": 2,
                    "severity": 3,
                    "code": 4,
                    "message": 5
                }
            }
        },
        {
            "label": "Configure cisTEM DEBUG build",
            "type": "shell",
            "command": "mkdir -p ${build_dir}/intel-gpu-debug-static && cd ${build_dir}/intel-gpu-debug-static && CC=icc CXX=icpc ../../configure ${input:additional_compiler_flags} --enable-debugmode --enable-gpu-debug --with-wx-config=/opt/WX/icc-static/bin/wx-config --enable-staticmode --with-cuda=${cuda_dir} ${experimental_algo_flags} ${common_optional_programs}  ${common_flags} "
        },
        {
            "label": "BUILD cisTEM DEBUG",
            "type": "shell",
            "command": "cd ${build_dir}/intel-gpu-debug-static && make -j${input:compile_cores} 2>&1 | sed -u 's|../../../src/|${workspaceFolder}/src/|g'",
            "problemMatcher": {
                "owner": "icpc",
                "fileLocation": "absolute",
                "pattern": {
                    "regexp": "^(.*)\\((\\d+)\\):\\s+(warning|error|remark)\\s+#?(\\d+)?:\\s+(.*)$",
                    "file": 1,
                    "line": 2,
                    "severity": 3,
                    "code": 4,
                    "message": 5
                }
            }
        },
        {
            "label": "Configure cisTEM DEBUG build TMPVALUE",
            "type": "shell",
            "command": "mkdir -p ${build_dir}/intel-gpu-debug-static-tmpvalue && cd ${build_dir}/intel-gpu-debug-static-tmpvalue && CC=icc CXX=icpc ../../configure ${input:additional_compiler_flags} --enable-debugmode --enable-gpu-debug --with-wx-config=/opt/WX/icc-static/bin/wx-config --enable-staticmode --with-cuda=${cuda_dir} ${experimental_algo_flags} ${common_optional_programs}  ${common_flags} --enable-build-calculate-template-pvalue"
        },
        {
            "label": "BUILD cisTEM DEBUG TMPVALUE",
            "type": "shell",
            "command": "cd ${build_dir}/intel-gpu-debug-static-tmpvalue && make -j${input:compile_cores} 2>&1 | sed -u 's|../../../src/|${workspaceFolder}/src/|g'",
            "problemMatcher": {
                "owner": "icpc",
                "fileLocation": "absolute",
                "pattern": {
                    "regexp": "^(.*)\\((\\d+)\\):\\s+(warning|error|remark)\\s+#?(\\d+)?:\\s+(.*)$",
                    "file": 1,
                    "line": 2,
                    "severity": 3,
                    "code": 4,
                    "message": 5
                }
            }
        },
        {
            "label": "Configure cisTEM DEBUG build, CPU only",
            "type": "shell",
            "command": "mkdir -p ${build_dir}/intel-debug-static && cd ${build_dir}/intel-debug-static && CC=icc CXX=icpc ../../configure ${input:additional_compiler_flags} --enable-debugmode --with-wx-config=/opt/WX/icc-static/bin/wx-config --enable-staticmode ${experimental_algo_flags} ${common_optional_programs}  ${common_flags} "
        },
        {
            "label": "BUILD cisTEM DEBUG, CPU only",
            "type": "shell",
            "command": "cd ${build_dir}/intel-debug-static && make -j${input:compile_cores} 2>&1 | sed -u 's|../../../src/|${workspaceFolder}/src/|g'",
            "problemMatcher": {
                "owner": "icpc",
                "fileLocation": "absolute",
                "pattern": {
                    "regexp": "^(.*)\\((\\d+)\\):\\s+(warning|error|remark)\\s+#?(\\d+)?:\\s+(.*)$",
                    "file": 1,
                    "line": 2,
                    "severity": 3,
                    "code": 4,
                    "message": 5
                }
            }
        },
        {
            "label": "Configure cisTEM DEBUG build with LibTorch",
            "type": "shell",
            "command": "mkdir -p ${build_dir}/intel-gpu-debug-static-libtorch && cd ${build_dir}/intel-gpu-debug-static-libtorch && CC=icc CXX=icpc ../../configure ${input:additional_compiler_flags} --enable-debugmode --enable-gpu-debug --with-wx-config=/opt/WX/icc-static/bin/wx-config --enable-staticmode --with-cuda=${cuda_dir} --enable-libtorch ${experimental_algo_flags} ${common_optional_programs}  ${common_flags} "
        },
        {
            "label": "BUILD cisTEM DEBUG with LibTorch",
            "type": "shell",
            "command": "cd ${build_dir}/intel-gpu-debug-static-libtorch && make -j${input:compile_cores} 2>&1 | sed -u 's|../../../src/|${workspaceFolder}/src/|g' && mkdir -p src/lib && cp -u /opt/libtorch/lib/libtorch.so* /opt/libtorch/lib/libtorch_cpu.so* /opt/libtorch/lib/libc10.so* /opt/libtorch/lib/libgomp*.so* src/lib/ 2>/dev/null || true",
            "problemMatcher": {
                "owner": "icpc",
                "fileLocation": "absolute",
                "pattern": {
                    "regexp": "^(.*)\\((\\d+)\\):\\s+(warning|error|remark)\\s+#?(\\d+)?:\\s+(.*)$",
                    "file": 1,
                    "line": 2,
                    "severity": 3,
                    "code": 4,
                    "message": 5
                }
            }
        },
        {
            "label": "CONFIG GNU, gpu",
            "type": "shell",
            "command": "mkdir -p ${build_dir}/GNU-gpu && cd ${build_dir}/GNU-gpu && CC=gcc CXX=g++ ../../configure  ${input:additional_compiler_flags} --with-cuda=${cuda_dir}  --enable-staticmode  --with-wx-config=/opt/WX/gcc-static/bin/wx-config ${experimental_algo_flags} ${common_optional_programs}  ${common_flags} "
        },
        {
            "label": "BUILD GNU, gpu",
            "type": "shell",
            "command": "cd ${build_dir}/GNU-gpu && make -j${input:compile_cores}"
        },
        {
            "label": "CONFIG clang, gpu",
            "type": "shell",
            "command": "mkdir -p ${build_dir}/clang-gpu && cd ${build_dir}/clang-gpu && CC=clang CXX=clang++ ../../configure  ${input:additional_compiler_flags} --with-cuda=${cuda_dir}  --enable-staticmode  --with-wx-config=/opt/WX/clang-static/bin/wx-config ${experimental_algo_flags} ${common_optional_programs}  ${common_flags} "
        },
        {
            "label": "BUILD clang, gpu",
            "type": "shell",
            "command": "cd ${build_dir}/clang-gpu && make -j${input:compile_cores}"
        },
        {
            "label": "Configure for Static Analysis (Clang + Bear)",
            "type": "shell",
            "command": "mkdir -p ${build_dir}/clang-tidy-debug && cd ${build_dir}/clang-tidy-debug && CC=clang CXX=clang++ ../../configure --enable-debugmode ${input:additional_compiler_flags} --with-cuda=${cuda_dir} --with-wx-config=/opt/WX/clang-static/bin/wx-config ${experimental_algo_flags} ${common_optional_programs} ${common_flags}",
            "group": "build",
            "problemMatcher": []
        },
        {
            "label": "Build with Bear (Generate compile_commands.json)",
            "type": "shell",
            "command": "cd ${build_dir}/clang-tidy-debug && bear -- make -j${input:compile_cores}",
            "group": "build",
            "dependsOn": ["Configure for Static Analysis (Clang + Bear)"],
            "problemMatcher": {
                "owner": "clang",
                "fileLocation": "autoDetect",
                "pattern": {
                    "regexp": "^(.*):(\\d+):(\\d+):\\s+(warning|error):\\s+(.*)$",
                    "file": 1,
                    "line": 2,
                    "column": 3,
                    "severity": 4,
                    "message": 5
                }
            }
        },
        {
            "label": "Clean Build with Bear (Full Database)",
            "type": "shell",
            "command": "cd ${build_dir}/clang-tidy-debug && make clean && bear -- make -j${input:compile_cores}",
            "group": "build",
            "problemMatcher": {
                "owner": "clang",
                "fileLocation": "autoDetect",
                "pattern": {
                    "regexp": "^(.*):(\\d+):(\\d+):\\s+(warning|error):\\s+(.*)$",
                    "file": 1,
                    "line": 2,
                    "column": 3,
                    "severity": 4,
                    "message": 5
                }
            }
        },
        {
            "label": "Link compile_commands.json to Root",
            "type": "shell",
            "command": "ln -sf ${build_dir}/clang-tidy-debug/compile_commands.json ${workspaceFolder}/compile_commands.json",
            "problemMatcher": []
        },
        {
            "label": "Analyze Tensor Code (clang-tidy)",
            "type": "shell",
            "command": "find ${workspaceFolder}/src/core/tensor -name '*.cpp' -o -name '*.cu' | xargs run-clang-tidy-14 -p ${build_dir}/clang-tidy-debug -quiet",
            "group": "test",
            "problemMatcher": {
                "owner": "clang-tidy",
                "fileLocation": ["relative", "${workspaceFolder}"],
                "pattern": {
                    "regexp": "^(.*):(\\d+):(\\d+):\\s+(warning|error):\\s+(.*)\\s+\\[(.*)\\]$",
                    "file": 1,
                    "line": 2,
                    "column": 3,
                    "severity": 4,
                    "message": 5,
                    "code": 6
                }
            }
        },
        {
            "label": "Analyze Changed Files (clang-tidy-diff)",
            "type": "shell",
            "command": "git diff -U0 ${input:base_branch} | clang-tidy-diff-14.py -p1 -path ${build_dir}/clang-tidy-debug -quiet",
            "group": "test",
            "problemMatcher": {
                "owner": "clang-tidy",
                "fileLocation": ["relative", "${workspaceFolder}"],
                "pattern": {
                    "regexp": "^(.*):(\\d+):(\\d+):\\s+(warning|error):\\s+(.*)\\s+(.*)\\]$",
                    "file": 1,
                    "line": 2,
                    "column": 3,
                    "severity": 4,
                    "message": 5,
                    "code": 6
                }
            }
        },
        {
            "label": "Deep Analysis (scan-build)",
            "type": "shell",
            "command": "cd ${build_dir}/clang-tidy-debug && scan-build-14 -o ${workspaceFolder}/.claude/cache/scan-results make -j${input:compile_cores}",
            "group": "test",
            "problemMatcher": []
        }
    ],
    "inputs": [
        {
            "type": "promptString",
            "id": "compile_cores",
            "description": "Number of threads for compiling.",
            "default": "8"
        },
        {
            "type": "promptString",
            "id": "additional_compiler_flags",
            "description": "additional_compiler_flags",
            "default": ""
        },
        {
            "type": "promptString",
            "id": "base_branch",
            "description": "Base branch to compare against for clang-tidy-diff",
            "default": "master"
        }
    ]
}