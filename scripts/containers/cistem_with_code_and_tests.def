Bootstrap: docker
From: bhimesbhimes/cistem_build_env:base_image_v1.5.0
#Stage: spython-base

%setup 

mkdir -p ${SINGULARITY_ROOTFS}/cisTEMx
mkdir -p ${SINGULARITY_ROOTFS}/cisTEMx/scripts

%files

# copy the cisTEMx folder
/home/himesb/git/cisTEM/build/intel-gpu/src /cisTEMx
# we'll use this to get information about the build environemnt, repo state and so on
/home/himesb/git/cisTEM/build/intel-gpu/config.log /cisTEMx
/home/himesb/git/cisTEM/scripts/testing/cistem_tests.sh /cisTEMx/scripts
/home/himesb/git/cisTEM/scripts/testing/beta_gal_benchmark /cisTEMx/scripts


%post -c /bin/bash

mv /cisTEMx/src /cisTEMx/bin
mv /cisTEMx/cistem_tests.sh /cisTEMx/bin


# Clean out some items we don't need in production
rm -rf /usr/local/cuda/nsight-systems-*
rm -rf /usr/local/cuda/nsight-compute-*



# Get reference images for testing and debugging
pip3 install gdown && cd /cisTEMx && gdown https://drive.google.com/drive/folders/1PO9tBU7lKqKUuSb8qdEPvlEk7xeektXv?usp --folder

chmod a+x /cisTEMx/* 



echo 'export MKLROOT=/opt/intel/oneapi/mkl/2021.4.0/' >>$APPTAINER_ENVIRONMENT
echo 'export NLSPATH=/opt/intel/oneapi/mkl/2021.4.0/lib/intel64/locale/%l_%t/%N' >>$APPTAINER_ENVIRONMENT
echo 'export CPATH=/opt/intel/oneapi/tbb/2021.4.0/env/../include:/opt/intel/oneapi/mkl/2021.4.0/include:/opt/intel/oneapi/compiler/2021.4.0/linux/include' >>$APPTAINER_ENVIRONMENT
echo 'export LIBRARY_PATH=/opt/intel/oneapi/tbb/2021.4.0/env/../lib/intel64/gcc4.8:/opt/intel/oneapi/mkl/2021.4.0/lib/intel64:/opt/intel/oneapi/compiler/2021.4.0/linux/compiler/lib/intel64_lin:/opt/intel/oneapi/compiler/2021.4.0/linux/lib' >>$APPTAINER_ENVIRONMENT
# NOTE: this also has the wx dynamic in it
echo 'export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/opt/WX/intel-dynamic/lib:/usr/local/cuda/lib64:/opt/intel/oneapi/tbb/2021.4.0/env/../lib/intel64/gcc4.8:/opt/intel/oneapi/mkl/2021.4.0/lib/intel64:/opt/intel/oneapi/compiler/2021.4.0/linux/lib:/opt/intel/oneapi/compiler/2021.4.0/linux/lib/x64:/opt/intel/oneapi/compiler/2021.4.0/linux/lib/emu:/opt/intel/oneapi/compiler/2021.4.0/linux/compiler/lib/intel64_lin:/.singularity.d/libs' >>$APPTAINER_ENVIRONMENT
echo 'export PATH=/usr/local/cuda/bin:/cisTEMx/src:${PATH}' >> $APPTAINER_ENVIRONMENT
echo 'export CISTEM_REF_IMAGES=/cisTEMx/cistem_reference_images' >> $APPTAINER_ENVIRONMENT



%environment

# export LANG=en_US.utf8
# export LD_RUN_PATH=/opt/libtorch/lib:${LD_RUN_PATH}

%runscript

# cd /home/cisTEMx
# exec /bin/bash "$@"

awk '/CISTEM_CURRENT_BRANCH/{print "This container built from branch: "$3}' /cisTEMx/config.log
awk '/CISTEM_TIME_READABLE/{print  "on                              : "$3 $4"\""}' /cisTEMx/config.log
awk '/CISTEM_VERSION_TEXT/{print   "corresponding version info      : "$3}' /cisTEMx/config.log
if [ -z "$1" ]; then
    echo "No arguments supplied"
    echo "Usage: apptainer run --nv cisTEMx_<current_version>.sif [bgal|unit]"
    exit 1
fi

case $1 in
    bgal)
        echo "Running beta galactosidase benchmark"
        /cisTEMx/scripts/beta_gal_benchmark/run_benchmark.sh
        ;;
    unit)
        echo "Running unit tests"
        /cisTEMx/scripts/cistem_tests.sh
        ;;
    *)
        echo "Unknown argument"
        echo "Usage: apptainer run --nv cisTEMx_<current_version>.sif [bgal|unit]"
        exit 1
        ;;
esac


%startscript

# cd /home/cisTEMx
# exec /bin/bash "$@"
