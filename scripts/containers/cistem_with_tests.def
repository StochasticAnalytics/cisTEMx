Bootstrap: docker
From: bhimesbhimes/cistem_build_env:base_image_v1.5.0
#Stage: spython-base

%setup 

mkdir -p ${SINGULARITY_ROOTFS}/.cistem_apptainer_cache
mkdir -p ${SINGULARITY_ROOTFS}/cisTEMx
mkdir -p ${SINGULARITY_ROOTFS}/cisTEMx/src

%files

# copy the cisTEMx folder
/home/himesb/git/cisTEM/build/intel-gpu/src/console_test /cisTEMx/src
/home/himesb/git/cisTEM/build/intel-gpu/src/samples_functional_testing /cisTEMx/src
/home/himesb/git/cisTEM/build/intel-gpu/src/unit_test_runner /cisTEMx/src
/home/himesb/git/cisTEM/scripts/testing/cistem_tests.sh /cisTEMx/src
/home/himesb/git/cisTEM/build/intel-gpu/src/gpu_devices /cisTEMx/src




%post -c /bin/bash


# Get reference images for testing and debugging
pip3 install gdown && cd /cisTEMx && gdown https://drive.google.com/drive/folders/1PO9tBU7lKqKUuSb8qdEPvlEk7xeektXv?usp --folder

chmod a+x /cisTEMx/src/* 





echo 'export MKLROOT=/opt/intel/oneapi/mkl/2021.4.0/' >>$APPTAINER_ENVIRONMENT
echo 'export NLSPATH=/opt/intel/oneapi/mkl/2021.4.0/lib/intel64/locale/%l_%t/%N' >>$APPTAINER_ENVIRONMENT
echo 'export CPATH=/opt/intel/oneapi/tbb/2021.4.0/env/../include:/opt/intel/oneapi/mkl/2021.4.0/include:/opt/intel/oneapi/compiler/2021.4.0/linux/include' >>$APPTAINER_ENVIRONMENT
echo 'export LIBRARY_PATH=/opt/intel/oneapi/tbb/2021.4.0/env/../lib/intel64/gcc4.8:/opt/intel/oneapi/mkl/2021.4.0/lib/intel64:/opt/intel/oneapi/compiler/2021.4.0/linux/compiler/lib/intel64_lin:/opt/intel/oneapi/compiler/2021.4.0/linux/lib' >>$APPTAINER_ENVIRONMENT
# NOTE: this also has the wx dynamic in it
echo 'export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/opt/WX/intel-dynamic/lib:/opt/intel/oneapi/tbb/2021.4.0/env/../lib/intel64/gcc4.8:/opt/intel/oneapi/mkl/2021.4.0/lib/intel64:/opt/intel/oneapi/compiler/2021.4.0/linux/lib:/opt/intel/oneapi/compiler/2021.4.0/linux/lib/x64:/opt/intel/oneapi/compiler/2021.4.0/linux/lib/emu:/opt/intel/oneapi/compiler/2021.4.0/linux/compiler/lib/intel64_lin:/.singularity.d/libs' >>$APPTAINER_ENVIRONMENT
echo 'export PATH=/usr/local/cuda/bin:/cisTEMx/src:${PATH}' >> $APPTAINER_ENVIRONMENT
echo 'export CISTEM_REF_IMAGES=/cisTEMx/cistem_reference_images' >> $APPTAINER_ENVIRONMENT



%environment

# export LANG=en_US.utf8
# export LD_RUN_PATH=/opt/libtorch/lib:${LD_RUN_PATH}

%runscript

# cd /home/cisTEMx
# exec /bin/bash "$@"

%startscript

# cd /home/cisTEMx
# exec /bin/bash "$@"
